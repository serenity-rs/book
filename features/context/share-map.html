<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ShareMap - serenity</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="../../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="../../features/about.html"><strong aria-hidden="true">2.</strong> Internals</a></li><li><ol class="section"><li><a href="../../features/tls.html"><strong aria-hidden="true">2.1.</strong> HTTP-Backend</a></li><li><a href="../../features/client.html"><strong aria-hidden="true">2.2.</strong> WIP: Client</a></li><li><a href="../../features/context.html"><strong aria-hidden="true">2.3.</strong> Context</a></li><li><ol class="section"><li><a href="../../features/context/share-map.html" class="active"><strong aria-hidden="true">2.3.1.</strong> ShareMap</a></li><li><a href="../../features/context/shard-messenger.html"><strong aria-hidden="true">2.3.2.</strong> WIP: ShardMessenger</a></li><li><a href="../../features/context/cache.html"><strong aria-hidden="true">2.3.3.</strong> WIP: Cache</a></li><li><a href="../../features/context/http.html"><strong aria-hidden="true">2.3.4.</strong> WIP: Http</a></li></ol></li><li><a href="../../features/framework/about.html"><strong aria-hidden="true">2.4.</strong> TODO: Framework</a></li><li><a href="../../features/voice/about.html"><strong aria-hidden="true">2.5.</strong> TODO: Voice</a></li></ol></li><li><a href="../../examples/about.html"><strong aria-hidden="true">3.</strong> TODO: Examples</a></li><li><ol class="section"><li><a href="../../examples/args.html"><strong aria-hidden="true">3.1.</strong> TODO: Command Argument Processing</a></li></ol></li><li><a href="../../porting/about.html"><strong aria-hidden="true">4.</strong> Porting</a></li><li><ol class="section"><li><a href="../../porting/0.5-to-0.6/about.html"><strong aria-hidden="true">4.1.</strong> 0.5 to 0.6</a></li><li><ol class="section"><li><a href="../../porting/0.5-to-0.6/framework.html"><strong aria-hidden="true">4.1.1.</strong> Framework</a></li><li><a href="../../porting/0.5-to-0.6/http-cache.html"><strong aria-hidden="true">4.1.2.</strong> WIP: Http/Cache</a></li></ol></li></ol></li><li><a href="../../troubleshooting/about.html"><strong aria-hidden="true">5.</strong> TODO: Troubleshooting</a></li><li><ol class="section"><li><a href="../../troubleshooting/expected-token.html"><strong aria-hidden="true">5.1.</strong> TODO: Expected a token in the environment</a></li><li><a href="../../troubleshooting/invalid-permission.html"><strong aria-hidden="true">5.2.</strong> TODO: Invalid permission</a></li></ol></li><li><a href="../../appendix/about.html"><strong aria-hidden="true">6.</strong> Appendix</a></li><li><ol class="section"><li><a href="../../appendix/command-options.html"><strong aria-hidden="true">6.1.</strong> TODO: Command Options</a></li><li><a href="../../appendix/group-options.html"><strong aria-hidden="true">6.2.</strong> Group Options</a></li><li><a href="../../appendix/help-options.html"><strong aria-hidden="true">6.3.</strong> TODO: Help Options</a></li></ol></li><li><a href="../../glossary/glossary.html"><strong aria-hidden="true">7.</strong> WIP: Glossary</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">serenity</h1> 

                        <div class="right-buttons">
                            <a href="../../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><link rel="stylesheet" href="../../../css/span.css"></p>
<a class="header" href="#data-the-sharemap" id="data-the-sharemap"><h1>Data, the ShareMap</h1></a>
<a class="header" href="#good-to-know" id="good-to-know"><h3>Good to know:</h3></a>
<p><a href="https://doc.rust-lang.org/std/sync/struct.Arc.html">Arc</a>, <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html">RwLock</a>, <a href="https://doc.rust-lang.org/book/ch10-02-traits.html">Traits</a>, <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html">HashMap</a></p>
<a class="header" href="#about" id="about"><h3>About</h3></a>
<p>The first field is the <code>data</code>-field, wrapping a <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> inside an
atomic reference counter (<a href="https://doc.rust-lang.org/std/sync/struct.Arc.html">Arc</a>) and a read-write lock (<a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html">RwLock</a>).</p>
<p>Serenity provides a <code>Context</code> to every possible place you can imagine, we will
always be able to access it. You may or may not wonder:
&quot;Isn't this a great way to share my own types across Serenity?&quot;, and yes,
you are right! The <code>data</code>-field can store everything your wildest dreams desire:
A database-connection, a command-counter, chat-game-session-handler,
weather-API, ..., and so many more wonderful things!
There is no limit to this magic!</p>
<a class="header" href="#use" id="use"><h3>Use</h3></a>
<p>Under the hood, <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> is actually a <a href="https://docs.rs/typemap/0.3.3/typemap/struct.TypeMap.html">TypeMap</a> with set generics,
saving us from to doing the work. A <a href="https://docs.rs/typemap/0.3.3/typemap/struct.TypeMap.html">TypeMap</a> is a special kind of <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html">HashMap</a>
where keys can be <em>different</em> types, thus allowing multiple types of
keys instead of just one.</p>
<p><span class="info">
<img hspace="10%" src="../../../images/curious.png" alt="Logo" width="84px"
style="float: right;margin-right: 25px"/>
If you did not work with <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html">HashMap</a>s that much yet or the <em>multiple keys</em>
caused more confusion than it solved, then let's get practical for a second.<br>
As they say, <em>a <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html">HashMap</a> is worth a thousand words</em>: <code>HashMap&lt;String, u64&gt;</code>
is a <a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html">HashMap</a> that accepts <code>String</code>s as keys to access <code>u64</code>s.
Hence <code>String</code>s being our only allowed keys to grab <code>u64</code>s.<br>
In contrast, <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> enables us to use Rust-types as keys instead of just
<code>String</code>s to access different types instead of <code>u64</code>s only.
</span></p>
<p>In order to turn a type into a key, we need to implement the
<a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/trait.TypeMapKey.html">TypeMapKey</a>-trait for it.</p>
<pre><code class="language-rust ignore">1  struct CommandCounterKey;
2
3  impl TypeMapKey for CommandCounterKey {
4      type Value = HashMap&lt;String, u64&gt;;
5  }
</code></pre>
<p><span class="caption">Listing 1.2: Implementing <code>CommandCounterKey</code>.</span></p>
<p>In this example, we define a <code>CommandCounterKey</code>-type and by implementing
<a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/trait.TypeMapKey.html">TypeMapKey</a>-trait for <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a>.
Now we need to tell <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> what type we want to access,
luckily line 4 helps us: We define a type-alias for <code>HashMap&lt;String, u64&gt;</code>
named <code>Value</code>.
This is an associated type needed by the <a href="https://docs.rs/typemap/0.3.3/typemap/trait.Key.html">Key</a>-trait.</p>
<p><span class="info">
<img hspace="10%" src="../../../images/curious.png" alt="Logo" width="84px"
style="float: right;margin-right: 25px"/>
If you really are curious what happens behind the curtains, looking at
<a href="https://docs.rs/typemap/0.3.3/typemap/trait.Key.html">Key</a>'s source might be worth it or reading about
<a href="https://doc.rust-lang.org/book/ch19-03-advanced-traits.html#specifying-placeholder-types-in-trait-definitions-with-associated-types" title="associated types">associated types here</a>.
</span></p>
<p>Now let's see how we can construct a <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> and put our key-implementation
to use!</p>
<pre><code class="language-rust ignore">1  let mut client = Client::new(&amp;token, Handler).expect(&quot;Err creating client&quot;);
2
3  let mut data = client.data.write();
4  data.insert::&lt;CommandCounterKey&gt;(HashMap::default());
</code></pre>
<p><span class="caption">Listing 1.3: Inserting value for <code>CommandCounterKey</code>.</span></p>
<p>This is pretty straightforward. The [Client] will dispatch [Context] to all
the different places. So all we need to do is inserting our map-value and
somehow specify the key.<br />
Well, not so fast! As we can see in line 3, we are calling <code>write</code> on <code>data</code>
and bind it to a mutable variable. The reason is simple: Serenity is
multithreaded and this <a href="https://doc.rust-lang.org/std/sync/struct.RwLock.html">RwLock</a> ensures that only one thread can mutate
our <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> at once.<br />
There is one last thing left: Putting our inserted item to use. Well, we can do
this in every place inside Serenity, we will always find a [Context] being
passed to us.\</p>
<pre><code class="language-rust ignore">1  .before(|context, msg, command_name| {
2
3     let mut data = context.data.write();
4     let counter = data.get_mut::&lt;CommandCounterKey&gt;()
5          .expect(&quot;Expected CommandCounter in ShareMap.&quot;);
6     let entry = counter.entry(command_name.to_string()).or_insert(0);
7     *entry += 1;
8
9     true
10 })
</code></pre>
<p><span class="caption">Listing 1.4: Using <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> before a command gets
executed.</span></p>
<p>Here we access the <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> with our <code>CommandCounterKey</code> and bind the
value on <code>counter</code> in line 4.<br />
Furthermore, the line shows us that we need to pass the key-type as
generic-parametre on <code>get_mut</code>: <code>data.get_mut::&lt;CommandCounterKey&gt;()</code>.
You might notice the <code>expect</code> in line 5, yes, this will panic if you forgot
to add a value for <code>CommandCounterKey</code>, to prevent this make sure you did as
1.3 has shown.<br />
In line 6 we simply check if a command name has been used yet
and if not simply add it entry with the counter set to 0, as line 7 will
increment this counter already. In case you are wondering about line 9,
returning <code>true</code> continues the dispatch-process.</p>
<a class="header" href="#summary" id="summary"><h3>Summary</h3></a>
<p>To sum things up, <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> is <em>the</em> way to share your own dependencies
across Serenity.<br />
Initially, before starting the bot, we insert values just like in 1.3 and access
them wherever we want as shown in 1.4.<br />
Last but not least, it's important to keep the lock on the <a href="https://docs.rs/serenity/0.6.0-rc.0/serenity/prelude/type.ShareMap.html">ShareMap</a> as
short as possible, so that other executing threads do not need to wait too long.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../features/context.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../features/context/shard-messenger.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../../features/context.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../../features/context/shard-messenger.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
